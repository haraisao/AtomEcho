<!DOCTYPE html>
<html lang="ja">
    <head>
        <title>Hello Stack-chan</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <meta charset="utf-8">

        <script type="text/javascript">
            async function get_camera_image(){
                const res = await fetch('/get_camera_image', {
                    method: "POST", body: ""
                });
                const { width, height, data } = await res.json();
                const canvas = document.getElementById('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(width, height);

                const binary = atob(data); // Base64 → binary
                const buffer = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    buffer[i] = binary.charCodeAt(i);
                }

                for (let i = 0, j = 0; i < buffer.length; i += 2, j += 4) {
                    const value = (buffer[i] << 8) | buffer[i + 1];

                    // RGB565 → 8bit RGB変換
                    const r = ((value >> 11) & 0x1F) << 3;
                    const g = ((value >> 5) & 0x3F) << 2;
                    const b = (value & 0x1F) << 3;

                    imageData.data[j] = r;
                    imageData.data[j + 1] = g;
                    imageData.data[j + 2] = b;
                    imageData.data[j + 3] = 255; // Alpha
                }
                
                ctx.putImageData(imageData, 0, 0);
            }

            async function move(){
                var pn = document.getElementById('pan').value;
                var tlt = document.getElementById('tilt').value;

                const res = await fetch('/move', {
                    method: "POST",
                    body: "[" + pn + "," + tlt +"]"
                });
            }

            async function move_angle(x, y){
                var pn =  Math.trunc(x * 0.6);
                var tlt = Math.trunc(Math.max(Math.min(-y*0.3, 5), -25));
                const res = await fetch('/move', {
                    method: "POST",
                    body: "[" + pn + "," + tlt +"]"
                });
            }

            async function face(){
                var face_ = document.getElementById('face').value;
                const res = await fetch('/face', {
                    method: "POST",
                    body: face_
                });
            }

        </script>
    </head>
    <body>
        <h1>Chatbot</h1>
        <h3>リンク</h3>
        <ul>
            <li><a href="asr_tts.html">音声認識＆音声合成</a></li>
            <li><a href="edit_file.html">ファイルの修正</a></li>
        </ul>
    </body>
</html>
